
import React, { useState, useRef } from 'react';
import { Rocket, TrendingUp, Crown, Zap, ArrowRight, ChevronLeft, ChevronRight, FileText, Clock, Users, Calendar, Map, Target, CheckCircle2, ChevronUp, ChevronsDown, Lightbulb, Waypoints } from 'lucide-react';
import BrochureViewer from './BrochureViewer';
import Modal from './Modal';

const BROCHURE_IMAGES = [
  "https://www.dropbox.com/scl/fi/4x16xwu4vfqvpb66uhf9g/250325_02_114-A3-_-_02-728x1030.jpg?rlkey=903e438du7nwl2zxdvtuhkz0g&raw=1",
  "https://www.dropbox.com/scl/fi/y9rcf40o9pitgvjd7jf52/250430_114-A3-_-_B_-_-_01-729x1030.jpg?rlkey=biml4jgq8djcs680m2yqjp2u3&raw=1",
  "https://www.dropbox.com/scl/fi/3s5k7qr7ktc0rfh27v1z2/250430_114-A3-_-_B_-_-_02-729x1030.jpg?rlkey=7fzoxarncbiz63gbdttaj5iar&raw=1",
  "https://www.dropbox.com/scl/fi/30exwirm2iyfnaug61hzw/251204_-K-_02.jpg?rlkey=xlzhjv4d038j09siau6fkqpps&raw=1",
  "https://www.dropbox.com/scl/fi/e5ns81cucqjhw9v65h8jz/251204_-K-_03.jpg?rlkey=ytefc19dpfvy7vj49da6lvnhf&raw=1"
];

const COURSE_DATA = [
  {
    id: 'g10',
    label: '升高一',
    description: '高一是銜接國高中課程的關鍵期。課程首重弭平學科落差，強化核心觀念的建構。針對新課綱素養導向，我們引導學生調整讀書方法，培養自主學習與探究實作的能力。透過加深加廣的課程內容，為高中三年的學業奠定堅實基礎，並協助學生探索興趣，提早規劃未來的升學方向。',
    icon: <Rocket size={20} />,
    color: 'text-green-500', 
    classes: [
      { name: '高一數學班', desc: '銜接教材與基礎觀念建立，邏輯訓練', age: '高一', time: '週一/四 18:30', objectives: '適應高中數學的抽象性與符號化，建立嚴謹的數學邏輯架構。', target: '高一新生，希望建立紮實數學基礎的學生。', features: ['銜接教材弭平國高中落差', '重視定義與定理的推導', '每週隨堂測驗檢視成效', '資深名師親自授課解惑'], roadmap: ['暑期: 銜接課程與數與式', '上學期: 多項式與指數對數', '下學期: 三角比與數列級數'] },
      { name: '高一英文班', desc: '字彙量擴充與長篇閱讀技巧', age: '高一', time: '週二/五 18:30', objectives: '大幅擴充高中必備字彙量，掌握五大句型結構，提升閱讀速度。', target: '高一新生，希望提升英文閱讀與寫作能力的學生。', features: ['字根字首單字記憶法', '長篇新聞英語閱讀導讀', '基礎翻譯寫作架構訓練', '英聽與口說實力養成'], roadmap: ['暑期: 文法句型總整理', '上學期: 4500單字與閱讀', '下學期: 雜誌閱讀與聽力'] },
      { name: '高一國文班', desc: '古文觀止與閱讀素養導讀', age: '高一', time: '週六 13:30', objectives: '精讀核心古文三十篇，提升文言文閱讀理解能力，培養文學鑑賞力。', target: '高一新生，對文言文理解感到困難的學生。', features: ['核心古文逐字逐句解析', '現代文學名家作品賞析', '混合題型作答技巧指導', '國寫作文基礎架構建立'], roadmap: ['暑期: 現代文學選讀', '上學期: 核心古文(一)', '下學期: 核心古文(二)'] },
      { name: '高一物化班', desc: '基礎物理化學觀念建構與實驗', age: '高一', time: '週六 10:00', objectives: '建立物理化學基礎觀念，理解自然現象背後的科學原理，培養科學素養。', target: '高一新生，目標選讀自然組的學生。', features: ['圖解教學簡化抽象觀念', '生活實例連結科學原理', '重視探究與實作精神', '段考重點題型精準複習'], roadmap: ['暑期: 國高中銜接課程', '上學期: 基礎物理/化學(一)', '下學期: 基礎物理/化學(二)'] },
    ]
  },
  {
    id: 'g11',
    label: '升高二',
    description: '高二面臨選組分流與課程加深的挑戰。我們提供分流分班的專業教學，全面提升各科的深度與廣度，建立強大的學科自信。同步輔導學生累積高品質的學習歷程檔案，並透過專業諮詢協助釐清科系志向。在鞏固校內成績的同時，提前為學測與申請入學累積競爭優勢。',
    icon: <TrendingUp size={20} />,
    color: 'text-blue-500', 
    classes: [
      { name: '高二數學班', desc: '代數、幾何進階與三角函數', age: '高二', time: '週二/五 18:30', objectives: '深入探討三角函數、平面向量與空間幾何，培養空間想像力與運算能力。', target: '高二學生，數A/數B分流強化學習。', features: ['數A/數B分流專業教學', '空間幾何教具輔助理解', '難題破解思路引導', '歷屆考題趨勢分析'], roadmap: ['暑期: 三角函數先修', '上學期: 平面向量與直線圓', '下學期: 空間向量與矩陣'] },
      { name: '高二英文班', desc: '進階文法與寫作架構訓練', age: '高二', time: '週一/四 18:30', objectives: '精熟進階文法句型，提升長篇作文撰寫能力，目標學測英文滿級分。', target: '高二學生，目標學測英文 15 級分的學生。', features: ['主題式寫作模組訓練', '高級單字與片語擴充', 'CNN/BBC 新聞英語選讀', '翻譯寫作個別批改'], roadmap: ['暑期: 寫作句型特訓', '上學期: 7000單字與閱讀', '下學期: 模考實戰與寫作'] },
      { name: '高二國文班', desc: '國學常識與深究鑑賞', age: '高二', time: '週六 10:00', objectives: '統整國學常識脈絡，深化古文鑑賞深度，提升知性與情意寫作能力。', target: '高二學生，希望在國寫作文取得高分的學生。', features: ['國學常識系統化整理', '歷代文學流派深入探討', '知性題與情意題寫作', '大考中心範文解析'], roadmap: ['暑期: 國學常識統整', '上學期: 核心古文深化', '下學期: 寫作密集訓練'] },
      { name: '高二物化班', desc: '力學、電磁學與化學反應速率', age: '高二', time: '週六 13:30', objectives: '精通選修物理與化學，掌握繁雜計算與抽象概念，奠定分科測驗基礎。', target: '高二自然組學生，目標頂尖理工科系。', features: ['微積分觀念引入物理教學', '化學反應機制深入解析', '複雜電路與力學分析', '分科測驗高難度題型挑戰'], roadmap: ['暑期: 力學/化學計量', '上學期: 能量/氣體動力論', '下學期: 電磁學/有機化學'] },
    ]
  },
  {
    id: 'g12',
    label: '升高三',
    description: '進入高三備戰狀態，我們提供全方位的學測複習規劃與模擬考實戰演練。精準掌握最新的大考命題趨勢，透過大量題型練習提升解題速度與準確率。針對個人弱點進行精準補強，並提供申請入學的模擬面試與備審資料一對一輔導，全力協助學生在學測與分科測驗中脫穎而出，直攻頂尖大學。',
    icon: <Crown size={20} />,
    color: 'text-purple-500', 
    classes: [
      { name: '高三數學班', desc: '學測範圍總複習與難題解析', age: '高三', time: '週六 13:30', objectives: '針對學測數學範圍進行地毯式複習，強化跨單元整合與解題速度。', target: '高三考生，目標學測數學滿級分。', features: ['學測重點觀念總整理', '混合題型與素養題攻略', '高強度模考實戰演練', '錯題分析與弱點補強'], roadmap: ['暑期: 1-2冊總複習', '開學: 3-4冊總複習', '考前: 全範圍模考衝刺'] },
      { name: '高三英文班', desc: '模擬試題演練與翻譯寫作衝刺', age: '高三', time: '週六 10:00', objectives: '透過大量模考題型演練，維持語感與解題手感，衝刺學測英文高分。', target: '高三考生，目標學測英文頂標以上。', features: ['每週一份全真模擬試題', '翻譯寫作即時批改檢討', '時事關鍵字彙補充', '閱讀測驗速讀技巧'], roadmap: ['暑期: 文法單字總複習', '開學: 歷屆試題全攻略', '考前: 寫作與翻譯衝刺'] },
      { name: '高三國文班', desc: '混合題型與知性情意作文攻略', age: '高三', time: '週日 09:00', objectives: '精準掌握國綜與國寫命題趨勢，提升閱讀理解速度與寫作深度。', target: '高三考生，目標國文級分大躍進。', features: ['混合題型作答策略指導', '國寫兩大題型密集訓練', '必考古文重點再回顧', '現代詩文閱讀測驗'], roadmap: ['暑期: 古文三十篇總複習', '開學: 國寫密集特訓', '考前: 考前猜題與叮嚀'] },
      { name: '高三物化班', desc: '自然科綜合題型與跨科整合', age: '高三', time: '週五 18:30', objectives: '統整自然科探究與實作觀念，強化圖表分析與邏輯推理能力。', target: '高三自然組考生，目標學測自然滿級分。', features: ['探究與實作題型專題', '物理化學跨科題型解析', '歷屆學測自然科全詳解', '科學閱讀素養訓練'], roadmap: ['暑期: 選修物理化學複習', '開學: 學測自然科總複習', '考前: 跨科整合衝刺'] },
    ]
  },
  {
    id: 'sprint',
    label: '寒暑衝刺',
    description: '把握寒暑假與考前的黃金衝刺期，集中火力進行高強度的密集訓練。我們提供嚴謹的作息管理與安靜的 K 書環境，營造良性競爭的讀書氛圍。透過地毯式的重點複習與擬真模考，搭配專業老師的即時解惑，幫助學生在短時間內大幅提升實力，穩定軍心，以最佳狀態迎戰大考。',
    icon: <Zap size={20} />,
    color: 'text-red-500', 
    classes: [
      { name: '模考K書班', desc: '仿真模擬考與專人解惑輔導', age: '高一 ~ 高三', time: '考前/週日', objectives: '提供安靜專注的讀書空間，透過規律作息與考試，調整備戰狀態。', target: '需要高效率讀書環境與個別問題解答的學生。', features: ['比照大考規格模擬考試', '各科專業輔導老師駐班', '嚴格門禁與作息管理', '手機集中保管杜絕分心'], roadmap: ['段考前: 密集K書週', '學測前: 魔鬼衝刺營', '分科前: 最後加強班'] },
      { name: '考前總複習班', desc: '重點觀念地毯式複習與猜題', age: '高三', time: '考前衝刺', objectives: '在考前最後階段進行高濃度的重點複習，快速掃描必考觀念。', target: '高三考生，希望在最後關頭衝高分數。', features: ['名師考前精準猜題', '易混淆觀念最終釐清', '時事題型總整理', '考前心理建設與輔導'], roadmap: ['考前30天: 重點掃描', '考前14天: 錯題回顧', '考前7天: 穩定軍心'] },
    ]
  }
];

const TIMELINE_DATA = [
  { 
    grade: '升高中', 
    subtitle: '高中先修與學習轉換期', 
    goal: '提前起跑 × 適應高中節奏', 
    courses: ['高中先修課程（國文／英文／數學／物理／化學）', '高中學習方法與時間管理指導', '暑期銜接先修班'] 
  },
  { 
    grade: '高一', 
    subtitle: '基礎扎根關鍵年', 
    goal: '觀念建立 × 穩定輸出', 
    courses: ['高一國文閱讀理解與寫作訓練', '高一英文文法 × 閱讀 × 字彙累積', '高一數學觀念建構與題型練習', '高一物理／化學基礎課程', '寒暑假基礎強化班'] 
  },
  { 
    grade: '升高二', 
    subtitle: '能力整合與銜接期', 
    goal: '補強弱點 × 銜接進階內容', 
    courses: ['高一總複習銜接課程', '高二先修課程（數學／物理／化學／英文）', '暑期實力銜接班'] 
  },
  { 
    grade: '高二', 
    subtitle: '實力拉開差距期', 
    goal: '深化理解 × 建立解題效率', 
    courses: ['高二國文素養閱讀與寫作提升', '高二英文閱讀理解 × 長文分析', '高二數學重點單元強化', '高二物理／化學進階課程', '寒暑假實力提升衝刺班'] 
  },
  { 
    grade: '升高三', 
    subtitle: '升學戰力啟動期', 
    goal: '整合重點 × 對接升學考試', 
    courses: ['高中全科重點銜接課程', '學測／分科先修課程', '暑期升學啟動班'] 
  },
  { 
    grade: '高三', 
    subtitle: '全面備考實戰期', 
    goal: '穩定表現 × 精準得分', 
    courses: ['高三國文／英文／數學總複習', '物理／化學重點題型與觀念整合', 'K書班（讀書計畫訂定＋現場輔導）', '擬真模考與考後解析'] 
  },
  { 
    grade: '考前衝刺', 
    subtitle: '關鍵分數決勝期', 
    goal: '穩定心態 × 發揮實力', 
    courses: ['考前總複習衝刺班', '高頻考點快速掃描', '擬真模考實戰演練', '考前K書與個別重點指導'] 
  },
];

const SeniorCourseRoadmap: React.FC = () => {
  const [activeTab, setActiveTab] = useState(0);
  const [isBrochureOpen, setIsBrochureOpen] = useState(false);
  const [isPlanOpen, setIsPlanOpen] = useState(false);
  
  // NEW STATE
  const [selectedClass, setSelectedClass] = useState<any>(null);
  const [modalMode, setModalMode] = useState<'schedule' | 'detail'>('schedule');

  const timelineRef = useRef<HTMLDivElement>(null);
  const sectionRef = useRef<HTMLElement>(null);

  const nextTab = () => {
    setActiveTab((prev) => (prev + 1) % COURSE_DATA.length);
  };

  const prevTab = () => {
    setActiveTab((prev) => (prev - 1 + COURSE_DATA.length) % COURSE_DATA.length);
  };

  const handleTogglePlan = () => {
    if (!isPlanOpen) {
      // Opening
      setIsPlanOpen(true);
      setTimeout(() => {
        if (timelineRef.current) {
          const y = timelineRef.current.getBoundingClientRect().top + window.scrollY - 100;
          window.scrollTo({ top: y, behavior: 'smooth' });
        }
      }, 100);
    } else {
      // Closing
      handleCollapse();
    }
  };

  const handleCollapse = () => {
    // Scroll back to top of section first
    if (sectionRef.current) {
      const y = sectionRef.current.getBoundingClientRect().top + window.scrollY - 100;
      window.scrollTo({ top: y, behavior: 'smooth' });
    }
    // Delay closing to allow scroll to complete visibly
    setTimeout(() => {
      setIsPlanOpen(false);
    }, 500);
  };

  const openSchedule = (cls: any) => {
    setSelectedClass(cls);
    setModalMode('schedule');
  };

  const openDetail = (cls: any) => {
    setSelectedClass(cls);
    setModalMode('detail');
  };

  // Generate Mock Schedule Data
  const generateSchedule = (cls: any) => {
    const daysMap: Record<string, string> = { '週一': 'Mon', '週二': 'Tue', '週三': 'Wed', '週四': 'Thu', '週五': 'Fri', '週六': 'Sat', '週日': 'Sun' };
    let primaryDay = '週六';
    for (const d of Object.keys(daysMap)) {
      if (cls.time.includes(d)) {
        primaryDay = d;
        break;
      }
    }

    const topics = [
      '高中課程銜接 & 學習方法指導',
      '核心素養導讀 & 小組討論',
      '進階觀念推導 (一)',
      '進階觀念推導 (二)',
      '歷屆學測考題分析',
      '素養題型破解技巧',
      '模擬測驗與個別輔導',
      '階段性成果檢測'
    ];

    return Array.from({ length: 8 }).map((_, i) => ({
      date: `07/${String(i * 7 + 5).padStart(2, '0')}`,
      day: primaryDay,
      time: cls.time.includes(':') ? cls.time.split(' ')[1] + '-' + (parseInt(cls.time.split(' ')[1].split(':')[0]) + 3) + ':00' : '18:30-21:30',
      unit: `第 ${i+1} 單元`,
      courseName: topics[i]
    }));
  };

  const commonNotes = [
    "請準時出席，遲到超過 15 分鐘請先至櫃檯報到。",
    "請攜帶指定教材、筆記本與文具用品。",
    "課堂中請勿使用手機，並將手機轉為靜音。",
    "請假請提前 24 小時告知，以利安排補課。",
    "補習班保有課程異動之權利，如有變動將另行通知。"
  ];

  return (
    <section ref={sectionRef} id="course-roadmap" className="py-20 bg-slate-950 scroll-mt-24 relative overflow-hidden">
      {/* Texture Background */}
      <div className="absolute inset-0 opacity-10 bg-[radial-gradient(#ffffff33_1px,transparent_1px)] bg-[size:20px_20px]"></div>

      <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
        <div className="text-center mb-5 md:mb-12">
          <h2 className="text-purple-300 font-bold tracking-wide uppercase text-sm mb-3">育豪菁英</h2>
          <h3 className="text-3xl md:text-4xl font-extrabold text-white">高中課程規劃</h3>
        </div>

        <div className="flex flex-col md:flex-row gap-3 md:gap-8">
          
          {/* Mobile Navigation (Arrows) */}
          <div className="md:hidden flex flex-col gap-4">
            <div className="flex items-center justify-between bg-purple-800 rounded-xl p-2 border border-purple-700">
              <button 
                onClick={prevTab}
                className="p-3 rounded-lg text-white hover:bg-purple-700 transition-colors"
              >
                <ChevronLeft size={24} />
              </button>
              <div className="flex items-center gap-2">
                <span className={`p-2 rounded-full ${COURSE_DATA[activeTab].color.replace('text-', 'bg-').replace('500', '100')} text-purple-900`}>
                  {React.cloneElement(COURSE_DATA[activeTab].icon as React.ReactElement, { size: 20, className: 'text-purple-900' })}
                </span>
                <span className="text-xl font-bold text-white">{COURSE_DATA[activeTab].label}</span>
              </div>
              <button 
                onClick={nextTab}
                className="p-3 rounded-lg text-white hover:bg-purple-700 transition-colors"
              >
                <ChevronRight size={24} />
              </button>
            </div>
          </div>

          {/* Desktop/Tablet Sidebar Tabs */}
          <div className="hidden md:flex md:w-1/4 flex-col gap-2">
            {COURSE_DATA.map((subject, index) => (
              <button
                key={subject.id}
                onClick={() => setActiveTab(index)}
                className={`flex items-center gap-2 lg:gap-3 px-3 py-3 lg:px-6 lg:py-4 rounded-xl transition-all whitespace-nowrap text-left ${
                  activeTab === index 
                    ? `bg-white text-purple-900 shadow-lg font-bold transform scale-105` 
                    : 'bg-purple-900/50 text-purple-200 hover:bg-purple-800 border border-purple-800'
                }`}
              >
                <span className={`p-1.5 lg:p-2 rounded-full ${activeTab === index ? 'bg-purple-100 text-purple-600' : 'bg-purple-700 text-purple-300'} shrink-0`}>
                   {React.cloneElement(subject.icon as React.ReactElement, { size: 18 })}
                </span>
                <span className="text-sm lg:text-lg truncate">{subject.label}</span>
              </button>
            ))}

            {/* Desktop Action Buttons */}
            <button
              onClick={() => setIsBrochureOpen(true)}
              className="mt-4 flex items-center justify-center gap-2 px-6 py-4 rounded-xl transition-all bg-yellow-400 text-purple-900 font-bold hover:bg-yellow-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5"
            >
              <FileText size={20} />
              <span className="text-lg">熱門課程</span>
            </button>

            <button
              onClick={handleTogglePlan}
              className={`mt-2 flex items-center justify-center gap-2 px-6 py-4 rounded-xl transition-all font-bold shadow-md hover:shadow-lg transform hover:-translate-y-0.5 ${
                isPlanOpen 
                  ? 'bg-white text-purple-800 ring-2 ring-white' 
                  : 'bg-purple-800 text-white hover:bg-purple-700 border border-purple-600'
              }`}
            >
              <Map size={20} />
              <span className="text-lg">完整規劃</span>
            </button>
          </div>

          {/* Content Area */}
          <div className="md:w-3/4">
            
            {/* Category Description */}
            <div className="mb-8 animate-in fade-in duration-300">
               <p className="text-purple-100 leading-relaxed md:leading-loose text-base md:text-lg font-medium text-justify">
                  {COURSE_DATA[activeTab].description}
               </p>
            </div>

            {/* Class Cards */}
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 animate-in fade-in slide-in-from-right-4 duration-300">
              {COURSE_DATA[activeTab].classes.map((cls, idx) => (
                <div 
                  key={idx} 
                  className="bg-white border border-purple-200 rounded-xl p-6 hover:shadow-xl hover:-translate-y-1 transition-all group flex flex-col h-full"
                >
                  <div className="flex-1">
                    <h4 className="text-xl font-bold text-slate-900 mb-3 group-hover:text-purple-600 transition-colors">
                      {cls.name}
                    </h4>

                     {/* Meta Tags: Age & Time */}
                    <div className="flex flex-wrap gap-2 mb-4">
                      <div className="flex items-center gap-1.5 text-xs font-medium text-slate-600 bg-purple-50 px-2.5 py-1.5 rounded-md border border-purple-100">
                         <Users size={14} className="text-purple-600" /> 
                         <span>{cls.age}</span>
                      </div>
                      <div className="flex items-center gap-1.5 text-xs font-medium text-slate-600 bg-purple-50 px-2.5 py-1.5 rounded-md border border-purple-100">
                         <Clock size={14} className="text-purple-600" /> 
                         <span>{cls.time}</span>
                      </div>
                    </div>

                    <p className="text-slate-600 text-sm leading-relaxed mb-6">
                      {cls.desc}
                    </p>
                  </div>
                  
                  {/* Action Buttons */}
                  <div className="flex gap-2 mt-auto">
                     <button 
                       onClick={() => openSchedule(cls)}
                       className="flex-1 py-2.5 rounded-lg bg-slate-100 text-slate-700 text-sm font-bold hover:bg-slate-200 transition-colors flex items-center justify-center gap-1.5"
                     >
                        查看課表 <Calendar size={14} />
                     </button>
                     <button 
                       onClick={() => openDetail(cls)}
                       className="flex-1 py-2.5 rounded-lg bg-purple-600 text-white text-sm font-bold hover:bg-purple-700 transition-colors text-center flex items-center justify-center gap-1.5 shadow-md shadow-purple-200"
                     >
                        了解課程 <ArrowRight size={14} />
                     </button>
                  </div>
                </div>
              ))}
            </div>

            {/* Mobile Action Buttons (Moved below cards) */}
             <div className="grid grid-cols-2 gap-3 mt-6 md:hidden">
               <button
                onClick={() => setIsBrochureOpen(true)}
                className="flex items-center justify-center gap-2 px-4 py-3 rounded-xl transition-all bg-yellow-400 text-purple-900 font-bold hover:bg-yellow-300 shadow-sm"
              >
                <FileText size={18} />
                <span>熱門課程</span>
              </button>
              <button
                onClick={handleTogglePlan}
                className={`flex items-center justify-center gap-2 px-4 py-3 rounded-xl transition-all font-bold shadow-sm ${isPlanOpen ? 'bg-white text-purple-700' : 'bg-purple-700 text-white border border-purple-500'}`}
              >
                <Map size={18} />
                <span>完整規劃</span>
              </button>
             </div>
          </div>
        </div>

        {/* Full Plan Timeline Section (Vertical Centered) */}
        {isPlanOpen && (
          <div ref={timelineRef} className="mt-16 py-12 px-4 md:px-12 bg-white rounded-3xl shadow-xl animate-in fade-in slide-in-from-top-4 duration-500">
             <div className="flex flex-col items-center justify-center gap-2 mb-16 md:mb-20">
               <div className="flex items-center gap-3">
                 <Map className="text-purple-600" size={32} />
                 <h3 className="text-2xl md:text-3xl font-extrabold text-purple-800 text-center">高中完整學習規劃路徑</h3>
               </div>
               <p className="text-slate-500 font-medium">三年佈局，穩健迎戰學測與分科</p>
             </div>
             
             {/* Timeline Container: padding-bottom 12 (48px) to reserve space for rocket */}
             <div className="relative max-w-5xl mx-auto pt-4 md:pt-10 pb-12">
                {/* Central Line (Desktop) - Ends at 24px from bottom (bottom-6) which is center of rocket */}
                <div className="absolute left-1/2 top-0 bottom-6 w-1 bg-purple-100 -translate-x-1/2 rounded-full hidden md:block"></div>
                
                {/* Side Line (Mobile) - Ends at 24px from bottom (bottom-6) */}
                <div className="absolute left-6 top-0 bottom-6 w-1 bg-purple-100 -translate-x-1/2 rounded-full md:hidden"></div>

                {/* NEW: Start Icon - Bouncing ChevronsDown */}
                <div className="absolute top-0 left-6 md:left-1/2 -translate-x-1/2 -translate-y-1/2 z-10">
                   <div className="bg-purple-50 p-2 rounded-full border-2 border-purple-100 animate-bounce shadow-sm">
                      <ChevronsDown size={20} className="text-purple-600" />
                   </div>
                </div>
                
                <div className="space-y-8 md:space-y-16 mb-8"> 
                   {TIMELINE_DATA.map((step, idx) => (
                      <div key={idx} className={`flex flex-col md:flex-row items-center md:justify-between relative ${idx % 2 !== 0 ? 'md:flex-row' : 'md:flex-row-reverse'}`}>
                         
                         {/* Side Content: Recommended Course Direction (Desktop Only) */}
                         <div className={`hidden md:flex w-5/12 flex-col justify-center ${idx % 2 !== 0 ? 'items-end text-right' : 'items-start text-left'}`}>
                            <div className={`flex items-center gap-2 text-amber-500 font-bold mb-2 ${idx % 2 !== 0 ? 'flex-row' : 'flex-row-reverse'}`}>
                               <span className="font-bold text-lg">推薦選課方向</span>
                               <CheckCircle2 size={20} />
                            </div>
                            <ul className="space-y-2">
                                {step.courses.map(c => (
                                    <li key={c} className={`text-slate-600 font-medium hover:text-purple-600 transition-colors ${idx % 2 !== 0 ? 'mr-1' : 'ml-1'}`}>
                                        {c}
                                    </li>
                                ))}
                            </ul>
                         </div>
                         
                         {/* Center Dot */}
                         <div className="absolute left-6 md:left-1/2 -translate-x-1/2 w-8 h-8 rounded-full bg-yellow-400 border-4 border-purple-50 z-10 shadow-sm flex items-center justify-center group-hover:scale-110 transition-transform">
                             <div className="w-2 h-2 bg-purple-800 rounded-full"></div>
                         </div>

                         {/* Content Card */}
                         <div className={`w-[calc(100%-4rem)] ml-auto md:ml-0 md:w-5/12 group`}>
                            <div className={`bg-purple-50 rounded-2xl p-6 border border-purple-100 hover:bg-purple-100 transition-all hover:-translate-y-1 hover:shadow-lg relative flex flex-col ${idx % 2 !== 0 ? 'md:items-start md:text-left' : 'md:items-end md:text-right'}`}>
                                
                                {/* Step Label */}
                                <span className="inline-block px-3 py-1 bg-white rounded-lg text-purple-700 text-xs font-bold mb-3 border border-purple-200">
                                  Step {idx + 1}
                                </span>
                                
                                <h4 className="text-xl md:text-2xl font-bold text-purple-900 mb-1">{step.grade}</h4>
                                <p className="text-purple-700 font-bold text-sm md:text-base mb-4 tracking-wide">{step.subtitle}</p>
                                
                                <div className={`w-16 h-1.5 bg-yellow-400 rounded-full mb-5 opacity-90`}></div>
                                
                                <div className="w-full space-y-4">
                                    {/* Goal Section */}
                                    <div className={`text-sm md:text-base bg-white p-3 rounded-xl border border-purple-200 ${idx % 2 !== 0 ? 'md:text-left' : 'md:text-right'}`}>
                                        <div className={`flex items-center gap-2 text-amber-500 font-bold mb-1.5 ${idx % 2 !== 0 ? '' : 'md:flex-row-reverse'}`}>
                                            <Target size={16} />
                                            <span>學習目標</span>
                                        </div>
                                        <p className="text-slate-600 font-medium">{step.goal}</p>
                                    </div>

                                    {/* Mobile Only: Courses Section inside card */}
                                    <div className="md:hidden pt-4 border-t border-purple-200/50 mt-2">
                                        <div className="flex items-center gap-2 text-amber-500 font-bold mb-2">
                                            <CheckCircle2 size={16} />
                                            <span>推薦選課方向</span>
                                        </div>
                                        <ul className="space-y-1.5">
                                            {step.courses.map(c => (
                                                <li key={c} className="flex items-center gap-2 text-slate-700 text-sm">
                                                    <span className="w-1.5 h-1.5 bg-purple-500 rounded-full shrink-0"></span>
                                                    {c}
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                         </div>
                      </div>
                   ))}
                </div>

                {/* Bouncing Rocket Icon - Absolute position at bottom-0 */}
                {/* 
                   Vertical Alignment: 
                   - Timeline line ends at bottom-6 (24px)
                   - Rocket is h-12 (48px). bottom-0 places its center at 24px.
                   - Thus, line ends at center of rocket.
                   - Wrapped in a div to separate positioning transform from animation transform
                */}
                <div className="absolute bottom-0 left-6 md:left-1/2 -translate-x-1/2 z-10">
                  <div className="w-12 h-12 bg-white border-4 border-purple-100 rounded-full flex items-center justify-center shadow-lg animate-bounce">
                       <Rocket className="text-purple-600 w-6 h-6" />
                  </div>
                </div>
             </div>

             {/* Collapse Button - Moved OUTSIDE the timeline container */}
             <div className="flex justify-center mt-4">
                <button 
                  onClick={handleCollapse}
                  className="flex items-center gap-2 text-slate-500 hover:text-purple-700 transition-colors py-3 px-6 rounded-full hover:bg-slate-100 text-sm font-medium"
                >
                  <ChevronUp size={16} />
                  收起時間軸
                </button>
             </div>
          </div>
        )}
      </div>
      
      <BrochureViewer 
        isOpen={isBrochureOpen} 
        onClose={() => setIsBrochureOpen(false)} 
        images={BROCHURE_IMAGES} 
      />

      {/* Modal */}
      <Modal
        isOpen={!!selectedClass}
        onClose={() => setSelectedClass(null)}
        title={selectedClass ? (modalMode === 'schedule' ? `${selectedClass.name} - 課程表` : `${selectedClass.name} - 課程介紹`) : ''}
        maxWidth="max-w-4xl"
      >
        {selectedClass && modalMode === 'schedule' && (
          <div className="space-y-6">
             {/* Info Header */}
             <div className="flex flex-wrap gap-4 p-4 bg-slate-50 rounded-xl border border-slate-100">
                <div className="flex items-center gap-2">
                   <span className="text-slate-500 font-bold text-sm">上課對象：</span>
                   <span className="text-slate-900 font-medium">{selectedClass.age}</span>
                </div>
                <div className="flex items-center gap-2">
                   <span className="text-slate-500 font-bold text-sm">上課時間：</span>
                   <span className="text-slate-900 font-medium">{selectedClass.time}</span>
                </div>
             </div>

             {/* Schedule Table */}
             <div className="overflow-hidden rounded-xl border border-slate-200 shadow-sm">
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left min-w-[600px]">
                       <thead className="bg-slate-100 text-slate-700 font-bold uppercase">
                          <tr>
                             <th className="px-4 py-3 whitespace-nowrap">日期</th>
                             <th className="px-4 py-3 whitespace-nowrap">星期</th>
                             <th className="px-4 py-3 whitespace-nowrap">時間</th>
                             <th className="px-4 py-3 whitespace-nowrap">單元名稱</th>
                             <th className="px-4 py-3 whitespace-nowrap">課程名稱</th>
                          </tr>
                       </thead>
                       <tbody className="divide-y divide-slate-100">
                          {generateSchedule(selectedClass).map((row, idx) => (
                             <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                <td className="px-4 py-3 font-medium text-slate-900">{row.date}</td>
                                <td className="px-4 py-3 text-slate-500">{row.day}</td>
                                <td className="px-4 py-3 text-slate-500">{row.time}</td>
                                <td className="px-4 py-3 text-purple-600 font-bold">{row.unit}</td>
                                <td className="px-4 py-3 text-slate-700">{row.courseName}</td>
                             </tr>
                          ))}
                       </tbody>
                    </table>
                </div>
             </div>

             {/* Notes */}
             <div>
                <h4 className="font-bold text-slate-900 mb-3 flex items-center gap-2">
                   <div className="w-1.5 h-6 bg-yellow-400 rounded-full"></div>
                   課程注意事項
                </h4>
                <ul className="space-y-2 bg-yellow-50 p-5 rounded-xl text-slate-700 text-sm border border-yellow-100">
                   {commonNotes.map((note, i) => (
                      <li key={i} className="flex items-start gap-2">
                         <span className="text-yellow-500 font-bold">•</span>
                         {note}
                      </li>
                   ))}
                </ul>
             </div>
          </div>
        )}

        {selectedClass && modalMode === 'detail' && (
           <div className="space-y-8 p-2">
              {/* Header / Summary */}
              <div className="bg-purple-50/50 p-6 rounded-2xl border border-purple-100">
                 <p className="text-lg text-slate-700 leading-relaxed font-medium">
                   {selectedClass.desc}
                 </p>
                 <div className="flex flex-wrap gap-4 mt-6">
                    <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-lg shadow-sm border border-purple-100">
                       <Users size={18} className="text-purple-600" />
                       <span className="text-sm font-bold text-slate-700">對象：{selectedClass.target}</span>
                    </div>
                    <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-lg shadow-sm border border-purple-100">
                       <Target size={18} className="text-purple-600" />
                       <span className="text-sm font-bold text-slate-700">目標：{selectedClass.objectives}</span>
                    </div>
                 </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                 {/* Features */}
                 <div>
                    <h4 className="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
                       <Lightbulb className="text-yellow-500" />
                       課程特色
                    </h4>
                    <ul className="space-y-3">
                       {selectedClass.features && selectedClass.features.map((feat: string, i: number) => (
                          <li key={i} className="flex items-start gap-3 bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                             <CheckCircle2 className="text-purple-500 shrink-0 mt-0.5" size={18} />
                             <span className="text-slate-700">{feat}</span>
                          </li>
                       ))}
                    </ul>
                 </div>

                 {/* Roadmap */}
                 <div>
                    <h4 className="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
                       <Waypoints className="text-purple-600" />
                       系列課程規劃
                    </h4>
                    <div className="space-y-4">
                       {selectedClass.roadmap && selectedClass.roadmap.map((step: string, i: number) => (
                          <div key={i} className="flex items-center gap-4 relative group">
                             {/* Vertical Line */}
                             {i !== selectedClass.roadmap.length - 1 && (
                                <div className="absolute left-[19px] top-8 bottom-[-16px] w-0.5 bg-slate-200"></div>
                             )}
                             
                             <div className="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-700 font-bold shrink-0 z-10 border-4 border-white shadow-sm">
                                {i + 1}
                             </div>
                             <div className="flex-1 bg-white p-3 rounded-xl border border-slate-100 shadow-sm text-slate-700 font-medium">
                                {step}
                             </div>
                          </div>
                       ))}
                    </div>
                 </div>
              </div>
              
              {/* Call to Action */}
              <div className="pt-8 border-t border-slate-100 text-center">
                 <a 
                   href="#contact" 
                   onClick={() => setSelectedClass(null)}
                   className="inline-flex items-center gap-2 px-8 py-4 bg-purple-600 text-white font-bold rounded-xl shadow-lg hover:bg-purple-700 hover:shadow-purple-500/30 transition-all transform hover:-translate-y-1"
                 >
                    立即預約試聽 <ArrowRight size={20} />
                 </a>
                 <p className="mt-3 text-sm text-slate-400">名額有限，建議提早預約保留席位</p>
              </div>
           </div>
        )}
      </Modal>
    </section>
  );
};

export default SeniorCourseRoadmap;
